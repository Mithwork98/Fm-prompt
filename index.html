<script>
  // Speech recognition setup
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  let recognizer = null;
  let currentField = null;
  if (SpeechRecognition) {
    recognizer = new SpeechRecognition();
    recognizer.lang = 'en-US';
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;
    recognizer.onresult = (evt) => {
      const t = evt.results[0][0].transcript;
      if (currentField) {
        const el = document.getElementById(currentField);
        el.value = (el.value ? el.value + ' ' : '') + t;
      }
    };
    recognizer.onerror = (e) => { console.log('SpeechError', e); alert('Speech recognition error: ' + (e.error || e.message)); };
    recognizer.onend = () => { currentField = null; };
  }

  function startDict(fieldId) {
    if (!recognizer) { alert('Speech recognition not supported. Use Chrome or type manually.'); return; }
    currentField = fieldId;
    recognizer.start();
  }
  function stopDict() {
    if (recognizer) recognizer.stop();
    currentField = null;
  }

  // System prompt for specialist-level H&P
  const SYSTEM_PROMPT = `
You are a clinical documentation assistant for a Family Medicine physician. 
Generate an Epic-ready H&P note with the following headers:
CHIEF COMPLAINT, HISTORY OF PRESENT ILLNESS, PAST MEDICAL HISTORY, PAST SURGICAL HISTORY, MEDICATIONS (include dose/frequency), ALLERGIES, FAMILY HISTORY, SOCIAL HISTORY, REVIEW OF SYSTEMS, VITALS, PHYSICAL EXAM, ASSESSMENT & PLAN.

Constraints:
- Avoid note bloat; include only relevant ROS and exam findings.
- Use neutral, patient-friendly language.
- Include short, evidence-based plan per problem, as a specialist would write.
- Map each medication to its corresponding diagnosis.
- Provide high-level assessment & plan per problem, including monitoring, follow-up, and patient counseling.
- Provide EPIC_PROBLEMS if requested: "Diagnosis — ICD-10 — one-line justification".
- Output ONLY the H&P and EPIC_PROBLEMS blocks.
`;

  function buildPrompt() {
    const cc = document.getElementById('cc').value.trim();
    const hpi = document.getElementById('hpi').value.trim();
    const pmh = document.getElementById('pmh').value.trim();
    const meds = document.getElementById('meds').value.trim();
    const allergies = document.getElementById('allergies').value.trim();
    const vitals = document.getElementById('vitals').value.trim() || "Not reported";
    const exam = document.getElementById('exam').value.trim() || "Not reported";
    const detail = document.getElementById('detail').value;
    const includeICD = document.getElementById('icd').checked;
    const patientFriendly = document.getElementById('patientFriendly').checked;

    if (!cc && !hpi && !pmh) {
      if (!confirm('No CC/HPI/PMH entered. Continue?')) return;
    }

    let optionsText = `NOTE_LENGTH: ${detail === 'detailed' ? 'Detailed' : 'Concise'}.
INCLUDE_ICD: ${includeICD ? 'Yes' : 'No'}.
PATIENT_FRIENDLY_LANGUAGE: ${patientFriendly ? 'Yes' : 'No'}.
Do not include identifiers.`;

    let userInput =
`PATIENT INPUT:
CHIEF COMPLAINT: ${cc}
HPI: ${hpi}
PAST MEDICAL HISTORY: ${pmh}
MEDICATIONS: ${meds}
ALLERGIES: ${allergies}
VITALS: ${vitals}
EXAM: ${exam}
${optionsText}
END PATIENT INPUT.
`;

    const finalPrompt = SYSTEM_PROMPT + "\n\n" + userInput + `
OUTPUT FORMAT:
1) Generate H&P using exact headers.
2) Include medications linked to respective diagnoses.
3) Provide high-level, specialist-level assessment & plan for each problem.
4) Include EPIC_PROBLEMS if requested.
5) Output ONLY the H&P and EPIC_PROBLEMS.
`;

    document.getElementById('promptPreview').textContent = finalPrompt;
  }

  function copyPrompt() {
    const text = document.getElementById('promptPreview').textContent;
    if (!text) { alert('Build prompt first'); return; }
    navigator.clipboard.writeText(text).then(() => alert('Prompt copied! Paste into chat.openai.com'));
  }

  function openChat() {
    window.open('https://chat.openai.com/chat', '_blank');
  }

  function clearAll() {
    if (!confirm('Clear all fields?')) return;
    ['cc','hpi','pmh','meds','allergies','vitals','exam'].forEach(id => document.getElementById(id).value='');
    document.getElementById('promptPreview').textContent = '';
  }
</script>
